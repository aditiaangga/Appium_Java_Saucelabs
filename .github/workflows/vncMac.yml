name: macOS VNC Remote

on:
  workflow_dispatch:

jobs:
  macos-vnc:
    runs-on: macos-latest
    steps:
      - name: Enable Remote Login (SSH)
        run: |
          sudo systemsetup -setremotelogin on

      - name: Enable Screen Sharing (VNC)
        run: |
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
            -activate -configure -access -on \
            -clientopts -setvnclegacy -vnclegacy yes \
            -clientopts -setvncpw -vncpw "123456" \
            -restart -agent -privs -all

      - name: Download ngrok
        run: |
          curl -sSL https://bin.equinox.io/c/4VmDzA7iaHb/ngrok-stable-darwin-arm64.tgz -o ngrok.tgz
          tar -xvzf ngrok.tgz
          ./ngrok authtoken ${{ secrets.NGROK_AUTH_TOKEN }}

      - name: Create TCP tunnel for VNC (port 5900)
        run: |
          ./ngrok tcp 5900 > /dev/null &
          sleep 5
          echo "ðŸ”— VNC URL:"
          curl -s http://127.0.0.1:4040/api/tunnels | jq -r '.tunnels[0].public_url'
      
      - name: Keep runner alive
        run: sleep 1h
