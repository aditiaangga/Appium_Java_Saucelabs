name: macOS SSH Access (Stable)

on:
  workflow_dispatch:

jobs:
  ssh-access:
    runs-on: macos-latest

    steps:
      - name: Install ngrok
        run: brew install --cask ngrok

      - name: Create new SSH user
        run: |
          USERNAME=ghuser
          PASSWORD=github123

          # Buat user baru
          sudo sysadminctl -addUser $USERNAME -password $PASSWORD

          # Masukkan user ke grup admin
          sudo dscl . -append /Groups/admin GroupMembership $USERNAME

          # Aktifkan Remote Login (SSH)
          sudo systemsetup -setremotelogin on

          # Pastikan service SSH berjalan
          sudo launchctl load -w /System/Library/LaunchDaemons/ssh.plist

          echo "✅ User '$USERNAME' dibuat dengan password '$PASSWORD'"
          echo "✅ SSH sudah aktif"

      - name: Start ngrok tunnel for SSH
        env:
          NGROK_AUTHTOKEN: ${{ secrets.NGROK_AUTHTOKEN }}
        run: |
          ngrok config add-authtoken "$NGROK_AUTHTOKEN"
          ngrok tcp 22 > ngrok.log &
          sleep 5
          echo "================ NGROK TUNNEL INFO ================"
          cat ngrok.log | grep -Eo "tcp://[0-9a-zA-Z\.\-:]+"
          echo "===================================================="

      - name: Keep runner alive
        run: sleep 1h
